<h1 class="edit-profile-title">Edit Profile</h1>

<% if (success_msg && success_msg.length > 0) { %>
  <div class="flash-message success"><%= success_msg %></div>
<% } %>
<% if (error_msg && error_msg.length > 0) { %>
  <div class="flash-message error"><%= error_msg %></div>
<% } %>
<% if (error && error.length > 0) { %>
  <div class="flash-message error"><%= error %></div>
<% } %>

<form class="edit-profile-form" action="/profile/edit" method="POST" enctype="multipart/form-data">
    <label class="edit-profile-label" for="username">Username:</label>
    <input class="edit-profile-input" type="text" id="username" name="username" value="<%= user.username || '' %>" required>
    <p class="input-hint">
      Your username is unique and used in your profile URL (e.g., /profile/yourusername). 
      <% if (user.googleId) { %>
        It was auto-generated from your Google account. Customize it to make it your own!
      <% } else { %>
        Choose carefully as it identifies you across the platform.
      <% } %>
    </p>

    <label class="edit-profile-label" for="profileName">Profile Name:</label>
    <input class="edit-profile-input" type="text" id="profileName" name="profileName" value="<%= user.profileName %>">

    <label class="edit-profile-label" for="bio">Bio:</label>
    <textarea class="edit-profile-textarea" id="bio" name="bio"><%= user.bio %></textarea>

    <div class="profile-images-section">
        <div class="image-upload-container">
            <label class="edit-profile-label" for="profilePicture">Profile Picture:</label>
            <% if (user.profilePicture) { %>
                <div class="current-image">
                    <img src="<%= user.profilePicture %>" alt="Current Profile Picture" class="thumbnail">
                    <p>Current Profile Picture</p>
                </div>
            <% } %>
            <input class="edit-profile-input" type="file" id="profilePicture" name="profilePicture">
        </div>

        <div class="image-upload-container">
            <label class="edit-profile-label" for="coverPhoto">Cover Photo:</label>
            <% if (user.coverPhoto) { %>
                <div class="current-image">
                    <img src="<%= user.coverPhoto %>" alt="Current Cover Photo" class="thumbnail">
                    <p>Current Cover Photo</p>
                </div>
            <% } %>
            <input class="edit-profile-input" type="file" id="coverPhoto" name="coverPhoto">
            <p class="image-hint">Recommended size: 1000x250 pixels</p>
        </div>
    </div>

    <button class="edit-profile-button" type="submit">Save Changes</button>
</form>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.querySelector('.edit-profile-form');
    const usernameInput = document.getElementById('username');
    const originalUsername = usernameInput.value;

    form.addEventListener('submit', function (e) {
      const newUsername = usernameInput.value.trim();
      const usernameRegex = /^[a-zA-Z0-9_]{3,20}$/;
      if (!usernameRegex.test(newUsername)) {
        e.preventDefault();
        alert('Username must be 3-20 characters long, alphanumeric, and can include underscores.');
        return;
      }
      if (newUsername !== originalUsername) {
        if (!confirm('Changing your username will update your profile URL. Existing links to your profile may break. Are you sure you want to proceed?')) {
          e.preventDefault();
        }
      }
    });
  });
</script>