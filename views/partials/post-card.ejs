<%# partials/_post_card.ejs %>
<%# Assumes 'post', 'user' (profile owner), 'currentUser', 'isSubscribed', 'viewType' ('creator' or 'subscriber') are passed %>

<div class="post-card" id="post-<%= post._id %>">

    <%# --- Locked/Unlocked Content Logic (Only applies to 'subscriber' viewType) --- %>
    <%
        let showLocked = false;
        let showContent = true; // Assume content is shown by default
        let hasPurchased = false;

        if (viewType === 'subscriber' && post.special) {
             hasPurchased = currentUser && currentUser.purchasedContent &&
                            currentUser.purchasedContent.some(p => p.contentId.toString() === post._id.toString());
             if (!hasPurchased) {
                 showLocked = true;
                 showContent = false; // Don't show full content if locked
             }
        }
        // For 'creator' viewType, showContent is always true, showLocked is always false
        if (viewType === 'creator') {
            showContent = true;
            showLocked = false;
        }
    %>

    <%# --- Locked Content Placeholder --- %>
    <% if (showLocked) { %>
        <div class="locked-content-container">
            <% if (post.type === 'image' || post.type === 'video') { %>
                <%# Consider adding a blurred thumbnail of the actual content if possible %>
                <img src="https://placehold.co/400x300/cccccc/333333?text=Locked+Content" alt="Locked Content" class="post-image post-locked-placeholder">
            <% } %>
            <% if (post.writeUp) { %>
                 <p class="post-writeUp preview-text"><%= post.writeUp.substring(0, 100) %><% if (post.writeUp.length > 100) { %>...<% } %></p>
            <% } %>
            <div class="unlock-overlay">
                <i class="fa fa-lock"></i>
                <div>Unlock for ₦<%= post.unlockPrice %></div>
                <button class="unlock-button" data-content-id="<%= post._id %>" data-creator-id="<%= user._id %>">Unlock Post</button>
            </div>
        </div>
    <% } %>

    <%# --- Actual Content (Shown if not locked or if creator view) --- %>
    <% if (showContent) { %>
        <a href="/posts/<%= post._id %>" class="post-content-link">
            <% if (post.type === 'image') { %>
                <img src="<%= post.contentUrl %>" alt="Post Image" class="post-image">
            <% } else if (post.type === 'video') { %>
                <video controls class="post-video" preload="metadata"> <%# preload="metadata" is good practice %>
                    <source src="<%= post.contentUrl %>#t=0.1" type="<%= post.contentType || 'video/mp4' %>"> <%# Add #t=0.1 for thumbnail in some browsers %>
                    Your browser does not support the video tag.
                </video>
            <% } else if (post.type === 'text') { %>
                <p class="post-text"><%= post.writeUp %></p>
            <% } %>
            <% if (post.writeUp && post.type !== 'text') { %>
                <p class="post-writeUp"><%= post.writeUp %></p>
            <% } %>
        </a>
        <% if (viewType === 'creator' && post.special) { %>
            <p class="special-indicator creator-view">
                Special Content - Unlock Price: ₦<%= post.unlockPrice %>
            </p>
        <% } %>
    <% } %>

    <%# --- Post Actions (Like, Comment, Tip) --- %>
    <%# Only show actions if content is unlocked or if creator view %>
    <% if (showContent || showLocked) { %> <%# Show actions even on locked posts %>
    <div class="post-actions">
        <button class="like-button" data-post-id="<%= post._id %>">
            <i class="fa-solid fa-heart"></i> <%# Add logic later to show 'liked' state %>
            <span class="like-count"><%= post.likes ? post.likes.length : 0 %></span>
        </button>
        <button class="comment-icon" data-post-id="<%= post._id %>">
            <i class="fa-solid fa-comment"></i>
            <span class="comment-count"><%= post.comments ? post.comments.length : 0 %></span>
        </button>
        <%# Allow tipping on locked posts too? Your decision. %>
        <% if (currentUser && currentUser._id.toString() !== user._id.toString()) { %> <%# Don't show tip button to creator on their own post %>
            <button class="tip-button" data-post-id="<%= post._id %>" data-creator-id="<%= user._id %>">
                <i class="fa-solid fa-gift"></i>
                 Tip (<span class="tip-count"><%= post.totalTips || post.tipCount || 0 %></span>) <%# Use whichever field holds the tip count/sum %>
            </button>
        <% } %>
    </div>
    <% } %>

    <%# --- Comments Preview & Form (Only if content is unlocked or creator view) --- %>
    <% if (showContent) { %>
        <div class="comments">
            <% if (post.comments && post.comments.length > 0) { %>
                <% post.comments.slice(0, 2).forEach(comment => { %>
                    <div class="comment">
                         <%# Add check for comment.user existence %>
                         <strong><%= comment.user ? comment.user.username : 'User' %>:</strong> <%= comment.text %>
                    </div>
                <% }); %>
                <% if (post.comments.length > 2) { %>
                    <a href="/posts/<%= post._id %>" class="view-all-comments">View all <%= post.comments.length %> comments</a>
                <% } %>
            <% } %>
        </div>

        <div class="comment-form-container hidden"> <%# JS toggles this %>
            <form class="comment-form" data-post-id="<%= post._id %>">
                <input type="text" name="comment" placeholder="Write a comment...">
                <button type="submit">Post</button>
            </form>
        </div>
    <% } %>

    <%# --- Creator Delete Button --- %>
    <% if (viewType === 'creator') { %>
        <form action="/profile/delete-post/<%= post._id %>" method="POST" onsubmit="return confirm('Are you sure you want to delete this post?');" class="delete-post-form">
            <button type="submit" class="delete-post-btn">Delete Post</button>
        </form>
    <% } %>

</div> <%# End post-card %>