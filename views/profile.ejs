<div class="profile-container">
    <h1 class="pro-welcome-message">Welcome, <%= user.username %></h1>
    <a class="home-page-link" href="/home">Home</a>
    <p class="pro-email">Email: <%= user.email %></p>
  
    <% if (user.profileName) { %>
      <p class="profile-name">Profile Name: <%= user.profileName %></p>
    <% } %>
  
    <% if (user.bio) { %>
      <p class="bio">Bio: <%= user.bio %></p>
    <% } %>
  
    <% if (user.profilePicture) { %>
      <img class="profile-picture" src="<%= user.profilePicture %>" alt="Profile Picture">
    <% } else { %>
      <img class="profile-picture" src="/uploads/default-profile-picture.jpg" alt="Default Profile Picture">
    <% } %>
  
    <% if (currentUser && currentUser._id.toString() === user._id.toString()) { %>
      <!-- Creator viewing their own profile -->
      <a class="pro-edit-profile-link" href="/profile/edit">Edit Profile</a>
      <h2 class="pro-settings-title">Settings</h2>
      <a class="pro-settings-link" href="/settings">Go to Settings</a>
  
      <% if (currentUser.role === 'creator') { %>
        <!-- Upload Content Section -->
        <h3>Upload Content</h3>
        <form action="/profile/uploadContent" method="POST" enctype="multipart/form-data">
          <label for="contentImage">Upload Image</label>
          <input type="file" name="contentImage" accept="image/*">
          <label for="contentVideo">Upload Video</label>
          <input type="file" name="contentVideo" accept="video/*">
          <label for="writeUp">Write-up / Caption</label>
          <textarea name="writeUp" id="writeUp"></textarea>
          <button type="submit">Upload</button>
        </form>
  
        <!-- Creator's Uploaded Content -->
        <% if (user.uploadedContent && user.uploadedContent.length > 0) { %>
          <div class="uploaded-content">
            <h2>Your Uploaded Content</h2>
            <div class="uploaded-content-list">
              <% user.uploadedContent.forEach(content => { %>
                <div class="post-card">
                  <% if (content.type === 'image') { %>
                    <img src="<%= content.filename %>" alt="Uploaded Image" class="uploaded-image">
                  <% } else if (content.type === 'video') { %>
                    <video controls class="uploaded-video">
                      <source src="<%= content.filename %>" type="video/mp4">
                      Your browser does not support the video tag.
                    </video>
                  <% } else if (content.type === 'text') { %>
                    <p class="text-only-post"><%= content.writeUp %></p>
                  <% } %>
                  <!-- Display caption (write-up) for media posts -->
                  <% if ((content.type === 'image' || content.type === 'video') && content.writeUp) { %>
                    <p class="content-writeUp"><%= content.writeUp %></p>
                  <% } %>
                  <!-- Delete post button -->
                  <form action="/profile/delete-post/<%= content._id %>" method="POST" onsubmit="return confirm('Are you sure you want to delete this post?');">
                    <button type="submit" class="delete-post-btn">Delete Post</button>
                  </form>
                </div>
              <% }); %>
            </div>
          </div>
        <% } else { %>
          <p>You have not uploaded any content yet.</p>
        <% } %>
  
        <!-- Create Subscription Bundle Section -->
        <h3>Create Subscription Bundle</h3>
        <form action="/profile/create-bundle" method="POST">
          <label for="bundlePrice">Bundle Price:</label>
          <input type="number" name="price" id="bundlePrice">
          <label for="bundleDuration">Bundle Duration:</label>
          <input type="text" name="duration" id="bundleDuration">
          <label for="bundleDescription">Bundle Description:</label>
          <textarea name="description" id="bundleDescription"></textarea>
          <button type="submit">Create Bundle</button>
        </form>
  
        <!-- Subscription Bundles -->
        <% if (bundles && bundles.length > 0) { %>
          <div class="subscription-bundles">
            <h2>Your Subscription Bundles</h2>
            <ul class="bundles-list">
              <% bundles.forEach(bundle => { %>
                <li class="bundle-item">
                  <p>Price: <%= bundle.price %></p>
                  <p>Duration: <%= bundle.duration %></p>
                  <p>Description: <%= bundle.description %></p>
                </li>
              <% }); %>
            </ul>
          </div>
        <% } else { %>
          <p>No subscription bundles available.</p>
        <% } %>
      <% } %>
    <% } else { %>
      <!-- Viewer (non-creator or creator viewing someone else's profile) -->
      <% if (isSubscribed) { %>
        <form action="/profile/unsubscribe/<%= user._id %>" method="POST">
          <button type="submit" class="unsubscribe-btn">Unsubscribe</button>
        </form>
  
        <!-- Subscriber Content -->
        <% if (user.uploadedContent && user.uploadedContent.length > 0) { %>
          <div class="uploaded-content">
            <h2><%= user.username %>'s Uploaded Content</h2>
            <div class="uploaded-content-list">
              <% user.uploadedContent.forEach(content => { %>
                <div class="post-card">
                  <% if (content.type === 'image') { %>
                    <img src="<%= content.filename %>" alt="Uploaded Image" class="uploaded-image">
                  <% } else if (content.type === 'video') { %>
                    <video controls class="uploaded-video">
                      <source src="<%= content.filename %>" type="video/mp4">
                      Your browser does not support the video tag.
                    </video>
                  <% } else if (content.type === 'text') { %>
                    <p class="text-only-post"><%= content.writeUp %></p>
                  <% } %>
                  <% if ((content.type === 'image' || content.type === 'video') && content.writeUp) { %>
                    <p class="content-writeUp"><%= content.writeUp %></p>
                  <% } %>
                </div>
              <% }); %>
            </div>
          </div>
        <% } %>
  
        <!-- Subscription Bundles -->
        <% if (bundles && bundles.length > 0) { %>
          <div class="subscription-bundles">
            <h2><%= user.username %>'s Subscription Bundles</h2>
            <ul class="bundles-list">
              <% bundles.forEach(bundle => { %>
                <li class="bundle-item">
                  <p>Price: <%= bundle.price %></p>
                  <p>Duration: <%= bundle.duration %></p>
                  <p>Description: <%= bundle.description %></p>
                  <form action="/profile/subscribe" method="POST">
                    <input type="hidden" name="creatorId" value="<%= user._id %>">
                    <input type="hidden" name="bundleId" value="<%= bundle._id %>">
                    <button type="submit" class="subscribe-btn">Subscribe</button>
                  </form>
                </li>
              <% }); %>
            </ul>
          </div>
        <% } else { %>
          <p>No subscription bundles available.</p>
        <% } %>
      <% } else { %>
        <p>You must subscribe to view this creator's content.</p>
        <% if (bundles && bundles.length > 0) { %>
          <div class="subscription-bundles">
            <h2><%= user.username %>'s Subscription Bundles</h2>
            <ul class="bundles-list">
              <% bundles.forEach(bundle => { %>
                <li class="bundle-item">
                  <p>Price: <%= bundle.price %></p>
                  <p>Duration: <%= bundle.duration %></p>
                  <p>Description: <%= bundle.description %></p>
                  <form action="/profile/subscribe" method="POST">
                    <input type="hidden" name="creatorId" value="<%= user._id %>">
                    <input type="hidden" name="bundleId" value="<%= bundle._id %>">
                    <button type="submit" class="subscribe-btn">Subscribe</button>
                  </form>
                </li>
              <% }); %>
            </ul>
          </div>
        <% } else { %>
          <p>No subscription bundles available.</p>
        <% } %>
      <% } %>
    <% } %>
  
    <a class="pro-logout-link" href="/logout">Log out</a>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Find all subscription forms
      const subscriptionForms = document.querySelectorAll('form[action="/profile/subscribe"]');
      
      subscriptionForms.forEach(form => {
        form.addEventListener('submit', async function(e) {
          e.preventDefault(); // Prevent traditional form submission
          
          // Get the submit button
          const submitButton = form.querySelector('button[type="submit"]');
          const originalText = submitButton.textContent;
          submitButton.textContent = 'Processing...';
          submitButton.disabled = true;
  
          try {
            // Create FormData from the form
            const formData = new FormData(form);
            const data = {
              creatorId: formData.get('creatorId'),
              bundleId: formData.get('bundleId')
            };
  
            // Send POST request
            const response = await fetch('/profile/subscribe', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(data)
            });
  
            // Check if the response is valid and contains the paymentLink
            const result = await response.json();
            console.log('Subscription Response:', result);
  
            if (response.ok && result.status === 'success' && result.data && result.data.paymentLink) {
              console.log('Redirecting to payment link:', result.data.paymentLink);
  
              // Show the loading sign
              submitButton.textContent = 'Redirecting...';
              submitButton.disabled = true;
  
              // Ensure the payment link is a fully qualified URL (including protocol)
              const paymentLink = result.data.paymentLink.startsWith('http')
                ? result.data.paymentLink
                : window.location.origin + result.data.paymentLink;
  
              // Redirect to the payment page
              window.location.href = paymentLink;
            } else {
              // Reset button state if no valid payment link is found
              submitButton.textContent = originalText;
              submitButton.disabled = false;
              alert(result.message || 'Failed to initialize payment');
            }
          } catch (error) {
            console.error('Error:', error);
            submitButton.textContent = originalText;
            submitButton.disabled = false;
            alert('An error occurred while processing your request');
          }
        });
      });
    });
  </script>
  